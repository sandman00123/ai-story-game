<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AI Story Adventure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ===== Matrix theme ===== */
    :root { --green:#00ff66; --pad:14px; }
    html,body { height:100%; }
    body {
      margin: 20px;
      background: #000;
      color: var(--green);
      font-family: "Courier New", monospace;
    }
    h1 { margin: 0 0 10px; text-shadow: 0 0 10px var(--green); }

    /* Top bar + controls */
    .topbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    a.btn, button, select, input, textarea {
      border: 1px solid var(--green);
      color: var(--green);
      background:#000;
      border-radius: 10px;
      padding: 8px 10px;
      font-family: inherit;
    }
    a.btn { text-decoration:none; }
    a.btn:hover, button:hover { background: var(--green); color:#000; }
    label { opacity:.9; }
    select, input[type="range"], input[type="text"] { padding: 6px 10px; }
    .small { font-size: 12px; opacity: .85; margin-left:auto; }

    /* Story pane */
    #story {
      white-space: pre-wrap;
      border: 1px solid var(--green);
      padding: var(--pad);
      border-radius: 12px;
      min-height: 260px;
      background: #030303;
      box-shadow: 0 0 8px rgba(0,255,102,.2);
      overflow-y:auto;
    }

    /* Input area */
    textarea {
      width: 100%;
      height: 96px;
      margin-top: 10px;
      border-radius: 12px;
      padding: var(--pad);
      resize: vertical;
    }
    .buttons { display:flex; gap:10px; margin-top:8px; flex-wrap:wrap; }
    .meter { display:flex; align-items:center; gap:8px; }
    .range { width:170px; }

    /* Thinking dots animation */
    .thinking { display:inline-block; letter-spacing:4px; }
    .thinking span { opacity:.2; animation: blink 1.2s infinite; }
    .thinking span:nth-child(2){ animation-delay:.2s }
    .thinking span:nth-child(3){ animation-delay:.4s }
    @keyframes blink { 0%,20%{opacity:.2} 50%{opacity:1} 100%{opacity:.2} }

    /* Scanline effect */
    body::after {
      content:""; position:fixed; inset:0; pointer-events:none;
      background: repeating-linear-gradient(to bottom, rgba(0,255,102,.08) 0px, rgba(0,255,102,.05) 2px, transparent 4px);
      animation: flicker 1.5s infinite;
    }
    @keyframes flicker { 0%{opacity:.9} 50%{opacity:.7} 100%{opacity:.9} }
  </style>
</head>
<body>
  <h1>AI Story Adventure</h1>

  <!-- ===== Navigation & Controls ===== -->
  <div class="topbar">
    <a class="btn" href="/board.html">📖 View Storyboard</a>

    <label for="mood">Mood:</label>
    <select id="mood" aria-label="Story mood">
      <option value="horror">Horror</option>
      <option value="romance">Romance</option>
      <option value="sci-fi">Sci-Fi</option>
      <option value="fantasy">Fantasy</option>
      <option value="mystery">Mystery</option>
      <option value="comedy">Comedy</option>
      <option value="noir">Detective Noir</option>
    </select>

    <div class="meter" aria-label="Dramatic scale">
      <label for="drama">Dramatic:</label>
      <input id="drama" class="range" type="range" min="1" max="5" step="1" value="3" />
      <span id="dramaVal">3</span>
    </div>

    <label for="handle">Nickname:</label>
    <input id="handle" type="text" placeholder="Anon" style="width:140px;" />
    <button id="share" title="Share the current story to the community board">Share story</button>

    <div class="small"><span id="health">Checking server…</span></div>
  </div>

  <!-- ===== Story Window ===== -->
  <div id="story" aria-live="polite">Your story begins here…</div>

  <!-- ===== Player Input ===== -->
  <div style="margin-top:10px;">
    <h3>Your turn:</h3>
    <textarea id="input" placeholder="Write the next part… (e.g., “The group enters a dark tunnel.”)"></textarea>
    <div class="buttons">
      <button id="send">Continue</button>
      <button id="reset">Reset</button>
    </div>
    <div class="small">Tip: keep turns short (1–2 sentences) for snappier pacing and lower costs.</div>
  </div>

  <script>
    /* ===== Element refs ===== */
    const storyEl  = document.getElementById('story');
    const inputEl  = document.getElementById('input');
    const sendBtn  = document.getElementById('send');
    const resetBtn = document.getElementById('reset');
    const moodEl   = document.getElementById('mood');
    const dramaEl  = document.getElementById('drama');
    const dramaVal = document.getElementById('dramaVal');
    const healthEl = document.getElementById('health');
    const shareBtn = document.getElementById('share');
    const handleEl = document.getElementById('handle');

    /* ===== Persistent nickname ===== */
    handleEl.value = localStorage.getItem('story_handle') || '';
    handleEl.addEventListener('change', () => {
      localStorage.setItem('story_handle', handleEl.value.trim());
    });

    /* ===== Dramatic scale display ===== */
    dramaVal.textContent = dramaEl.value;
    dramaEl.addEventListener('input', () => {
      dramaVal.textContent = dramaEl.value;
    });

    /* ===== Story state (history for context) ===== */
    let history = []; // each item: { role: 'user'|'assistant', content: string }
    const MAX_TURNS_MEMORY = 8;

    function pushToStory(text, who) {
      storyEl.textContent += `\n\n${who}: ${text}`;
      storyEl.scrollTop = storyEl.scrollHeight;
    }

    function compactHistoryIfNeeded() {
      if (history.length > MAX_TURNS_MEMORY * 2) {
        const tail = storyEl.textContent.slice(-1600);
        history = [{ role: 'assistant', content: 'Recap so far:\n' + tail }];
      }
    }

    /* ===== Robust health check ===== */
    async function checkHealth() {
      try {
        const url = window.location.origin + '/api/health';
        const r = await fetch(url, { cache: 'no-store' });
        const j = await r.json();
        if (!r.ok) throw new Error('HTTP ' + r.status);
        healthEl.textContent = j.hasKey
          ? 'Server OK (API key loaded)'
          : 'Server OK (no API key)';
      } catch (err) {
        console.error('Health check failed:', err);
        healthEl.textContent = 'Server unreachable';
      }
    }
    window.addEventListener('load', checkHealth);

    /* ===== Typing effect for narrator ===== */
    function typeText(fullText, whoLabel = 'Narrator') {
      let i = 0;
      const prefix = `\n\n${whoLabel}: `;
      storyEl.textContent += prefix;
      const timer = setInterval(() => {
        storyEl.textContent += fullText.charAt(i++);
        storyEl.scrollTop = storyEl.scrollHeight;
        if (i >= fullText.length) clearInterval(timer);
      }, 18);
    }

    /* ===== Thinking dots line ===== */
    let thinkingNode = null;
    function showThinking() {
      const tmp = document.createElement('div');
      tmp.textContent = '\n\nNarrator: ';
      const dots = document.createElement('span');
      dots.className = 'thinking';
      dots.innerHTML = '<span>•</span><span>•</span><span>•</span>';
      storyEl.appendChild(tmp);
      storyEl.appendChild(dots);
      storyEl.scrollTop = storyEl.scrollHeight;
      thinkingNode = { tmp, dots };
    }
    function hideThinking() {
      if (thinkingNode) {
        thinkingNode.tmp.remove();
        thinkingNode.dots.remove();
        thinkingNode = null;
      }
    }

    /* ===== Continue turn ===== */
    sendBtn.onclick = async () => {
      const userTurn = inputEl.value.trim();
      if (!userTurn) return;

      inputEl.value = '';
      pushToStory(userTurn, 'You');
      history.push({ role: 'user', content: userTurn });

      try {
        compactHistoryIfNeeded();
        showThinking();

        const res = await fetch(window.location.origin + '/api/continue', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            history,
            userTurn,
            mood: moodEl.value,
            drama: dramaEl.value
          })
        });

        const data = await res.json().catch(() => ({}));
        hideThinking();

        if (!res.ok) {
          const msg = (data && data.error) ? data.error : `HTTP ${res.status}`;
          throw new Error(msg);
        }

        const aiText = (data.text || '[Empty response]').trim();
        typeText(aiText, 'Narrator');
        history.push({ role: 'assistant', content: aiText });
      } catch (e) {
        hideThinking();
        pushToStory('[Error: ' + e.message + ']', 'System');
      }
    };

    /* ===== Reset session ===== */
    resetBtn.onclick = () => {
      history = [];
      storyEl.textContent = 'Your story begins here…';
      inputEl.value = '';
    };

    /* ===== Gather full story text ===== */
    function currentStoryText() {
      return storyEl.textContent.trim();
    }

    /* ===== Share to Storyboard ===== */
    shareBtn.onclick = async () => {
      const content = currentStoryText();
      if (!content || content === 'Your story begins here…') {
        alert('Write a bit of story first!');
        return;
      }
      const title = prompt('Story title?', 'Untitled adventure') || 'Untitled adventure';
      const mood = moodEl.value;
      const drama = dramaEl.value;
      const author = handleEl.value.trim() || 'Anon';

      try {
        const r = await fetch(window.location.origin + '/api/storyboard/share', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, mood, drama, content, author })
        });
        const j = await r.json();
        if (!r.ok) throw new Error(j.error || 'Failed to share');
        alert('Shared! Opening storyboard…');
        window.location.href = '/board.html';
      } catch (e) {
        alert('Share failed: ' + e.message);
      }
    };
  </script>
</body>
</html>
