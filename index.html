<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AI Story Adventure</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      /* Matrix-style look */
      body {
        font-family: "Courier New", monospace;
        background: #000;
        color: #00ff66;
        margin: 20px;
      }

      h1 {
        text-align: center;
        color: #00ff66;
        text-shadow: 0 0 10px #00ff66;
        margin-bottom: 20px;
      }

      .bar {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 16px; padding: 10px;
        border: 1px solid #00ff66; border-radius: 6px; background: #0a0a0a;
      }

      .controls { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
      label { font-size: 14px; }
      select, input[type=range] {
        background: #000; color: #00ff66; border: 1px solid #00ff66; border-radius: 6px; padding: 4px 6px;
      }
      #dramaValue { min-width: 20px; display: inline-block; text-align: center; }

      #story {
        background: #0a0a0a; border: 1px solid #00ff66; border-radius: 8px;
        padding: 16px; min-height: 250px; overflow-y: auto; box-shadow: 0 0 12px #00ff66 inset;
      }

      .line { margin: 8px 0; }
      .role { color: #00ff66; font-weight: bold; }
      .you .role { color: #33ffaa; }
      .system .role { color: #66ffcc; }

      textarea {
        width: 100%; height: 90px; margin-top: 12px;
        border-radius: 6px; border: 1px solid #00ff66; background: #000; color: #00ff66;
        padding: 12px; resize: none; font-family: "Courier New", monospace;
      }

      .buttons { display: flex; gap: 10px; margin-top: 10px; }
      button {
        flex: 1; padding: 12px; cursor: pointer; border-radius: 6px;
        border: 1px solid #00ff66; background: #000; color: #00ff66; font-weight: bold;
        text-transform: uppercase; transition: all 0.2s;
      }
      button:hover { background: #00ff66; color: #000; box-shadow: 0 0 10px #00ff66; }
      button.primary { background: #003300; }
      button.primary:hover { background: #00ff66; color: #000; }

      .small { font-size: 12px; opacity: 0.8; }
      .note { margin-top: 10px; opacity: 0.8; }

      /* Screen scanlines */
      body::after {
        content: ""; position: fixed; inset: 0; pointer-events: none;
        background: repeating-linear-gradient(to bottom,
          rgba(0, 255, 102, 0.08) 0px,
          rgba(0, 255, 102, 0.05) 2px,
          transparent 4px);
        animation: flicker 1.5s infinite;
      }
      @keyframes flicker { 0%{opacity:.9} 50%{opacity:.7} 100%{opacity:.9} }

      /* Thinking dots */
      .thinking { display: inline-flex; gap: 6px; align-items: center; }
      .dot {
        width: 6px; height: 6px; border-radius: 50%; background: #004d26;
        box-shadow: 0 0 0px #00ff66;
        animation: pulse 1s infinite ease-in-out;
      }
      .dot:nth-child(1){ animation-delay: 0s; }
      .dot:nth-child(2){ animation-delay: .2s; }
      .dot:nth-child(3){ animation-delay: .4s; }
      @keyframes pulse {
        0%   { background:#004d26; box-shadow:0 0 0px #00ff66; transform: translateY(0); }
        50%  { background:#00ff66; box-shadow:0 0 10px #00ff66; transform: translateY(-2px); }
        100% { background:#004d26; box-shadow:0 0 0px #00ff66; transform: translateY(0); }
      }

      /* Caret for typing effect */
      .caret {
        display:inline-block; width:8px; height:1.1em; background:#00ff66; margin-left:2px;
        animation: caretBlink .8s steps(1) infinite;
      }
      @keyframes caretBlink { 0%{opacity:1} 50%{opacity:0} 100%{opacity:1} }
    </style>
  </head>
  <body>
    <h1>AI Story Adventure</h1>

    <div class="bar">
      <div class="controls">
        <label for="mood">Story mood:</label>
        <select id="mood">
          <option value="horror">Horror</option>
          <option value="romance">Romance</option>
          <option value="sci-fi">Sci-Fi</option>
          <option value="fantasy">Fantasy</option>
          <option value="mystery">Mystery</option>
          <option value="comedy">Comedy</option>
          <option value="noir">Detective Noir</option>
        </select>

        <label for="drama">Dramatic:</label>
        <input id="drama" type="range" min="1" max="5" step="1" value="3">
        <span id="dramaValue">3</span>
      </div>
      <div class="small">
        <span id="health">Checking server…</span>
      </div>
    </div>

    <div id="story">
      <div class="line system"><span class="role">System:</span> Your story begins here…</div>
    </div>

    <div class="row" style="margin-top:14px;">
      <h3>Your turn:</h3>
      <textarea id="input" placeholder="Write the next part…"></textarea>
      <div class="buttons">
        <button id="send" class="primary">Continue</button>
        <button id="reset">Reset</button>
      </div>
      <div class="note small">
        Tip: keep turns short (1–2 sentences) for snappier pacing and lower costs.
      </div>
    </div>

    <script>
      const storyEl = document.getElementById('story');
      const inputEl = document.getElementById('input');
      const sendBtn = document.getElementById('send');
      const resetBtn = document.getElementById('reset');
      const moodEl = document.getElementById('mood');
      const dramaEl = document.getElementById('drama');
      const dramaValueEl = document.getElementById('dramaValue');
      const healthEl = document.getElementById('health');

      let history = []; // { role: 'user'|'assistant', content: string }

      // Update drama value UI
      dramaEl.oninput = () => dramaValueEl.textContent = dramaEl.value;

      // Health check
      async function checkHealth() {
        try {
          const r = await fetch('/api/health');
          const j = await r.json();
          healthEl.textContent = j.hasKey
            ? 'Server OK (API key loaded)'
            : 'Server OK (no API key)';
        } catch {
          healthEl.textContent = 'Server unreachable';
        }
      }
      checkHealth();

      // Helpers to append lines and effects
      function appendLine(role, text = "") {
        const line = document.createElement('div');
        line.className = `line ${role.toLowerCase()}`;
        line.innerHTML = `<span class="role">${role}:</span> <span class="content">${escapeHtml(text)}</span>`;
        storyEl.appendChild(line);
        storyEl.scrollTop = storyEl.scrollHeight;
        return line.querySelector('.content');
      }

      function showThinkingPlaceholder() {
        const line = document.createElement('div');
        line.className = 'line narrator';
        line.innerHTML = `
          <span class="role">Narrator:</span>
          <span class="content">
            <span class="thinking">
              <span class="dot"></span><span class="dot"></span><span class="dot"></span>
            </span>
          </span>`;
        storyEl.appendChild(line);
        storyEl.scrollTop = storyEl.scrollHeight;
        return line.querySelector('.content'); // return the content span we will replace
      }

      function clearNode(el) {
        while (el.firstChild) el.removeChild(el.firstChild);
      }

      // Typing effect
      async function typeText(targetEl, text, cps = 45) {
        // cps = characters per second (approx). 45 cps ~ 22ms per char.
        const delay = Math.max(8, Math.floor(1000 / cps));
        return new Promise(resolve => {
          let i = 0;
          const caret = document.createElement('span');
          caret.className = 'caret';
          const timer = setInterval(() => {
            targetEl.textContent += text[i] || '';
            i++;
            if (!caret.isConnected) targetEl.appendChild(caret);
            storyEl.scrollTop = storyEl.scrollHeight;
            if (i >= text.length) {
              clearInterval(timer);
              // small pause then remove caret
              setTimeout(() => { if (caret.parentNode) caret.parentNode.removeChild(caret); resolve(); }, 150);
            }
          }, delay);
        });
      }

      // Security for innerHTML
      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      // Keep context small
      const MAX_TURNS_MEMORY = 8;
      function compactHistoryIfNeeded() {
        if (history.length > MAX_TURNS_MEMORY * 2) {
          // Use current story text as a quick recap
          const allLines = Array.from(storyEl.querySelectorAll('.line'))
            .map(l => l.textContent).join('\n').slice(-1200);
          history = [{ role: 'assistant', content: 'Recap so far:\n' + allLines }];
        }
      }

      // Actions
      sendBtn.onclick = async () => {
        const userTurn = inputEl.value.trim();
        if (!userTurn) return;

        inputEl.value = '';

        appendLine('You', userTurn);
        history.push({ role: 'user', content: userTurn });

        // Show animated thinking dots where the narrator reply will go
        const contentSpan = showThinkingPlaceholder();

        try {
          compactHistoryIfNeeded();

          const res = await fetch('/api/continue', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              history,
              userTurn,
              mood: moodEl.value,
              drama: dramaEl.value
            })
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            const msg = (data && data.error) ? data.error : `HTTP ${res.status}`;
            clearNode(contentSpan);
            contentSpan.textContent = `[Error: ${msg}]`;
            contentSpan.parentElement.parentElement.classList.add('system');
            return;
          }

          // Replace dots with typing text
          const aiText = data.text || '[Empty response]';
          clearNode(contentSpan);
          await typeText(contentSpan, aiText, 50); // ~50 cps feels nice

          history.push({ role: 'assistant', content: aiText });

        } catch (e) {
          clearNode(contentSpan);
          contentSpan.textContent = `[Error: ${e.message}]`;
          contentSpan.parentElement.parentElement.classList.add('system');
        } finally {
          storyEl.scrollTop = storyEl.scrollHeight;
        }
      };

      resetBtn.onclick = () => {
        history = [];
        storyEl.innerHTML = `<div class="line system"><span class="role">System:</span> Your story begins here…</div>`;
      };
    </script>
  </body>
</html>
