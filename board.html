<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Storyboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* Matrix theme */
    body { font-family: "Courier New", monospace; background: #000; color: #00ff66; margin: 20px; }
    .top { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    a.link { color:#00ff66; text-decoration:none; border:1px solid #00ff66; padding:6px 10px; border-radius:8px; }
    a.link:hover { background:#00ff66; color:#000; }

    h1 { margin:10px 0; text-shadow: 0 0 10px #00ff66; }
    .nick { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .nick input, .filters input, .filters select {
      background:#000; color:#00ff66; border:1px solid #00ff66; border-radius:8px; padding:6px;
    }
    .filters { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:10px; margin:10px 0 4px; }
    .filters .row { display:flex; flex-direction:column; gap:6px; }
    .filters .actions { display:flex; gap:10px; align-items:center; }
    .filters button { background:#000; color:#00ff66; border:1px solid #00ff66; padding:6px 10px; border-radius:8px; cursor:pointer; }
    .filters button:hover { background:#00ff66; color:#000; }

    .status { font-size:12px; opacity:.9; margin: 4px 0 10px; }

    .story { border:1px solid #00ff66; border-radius:8px; background:#0a0a0a; padding:12px; margin:12px 0; }
    .title { font-weight:bold; margin-bottom:4px; }
    .meta { font-size:12px; opacity:.9; margin-bottom:8px; }
    .content { white-space:pre-wrap; margin-bottom:8px; }
    .actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .actions button { background:#000; color:#00ff66; border:1px solid #00ff66; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .actions button:hover { background:#00ff66; color:#000; }
    .actions button[disabled] { opacity:.5; cursor:progress; }

    .comments { margin-top:10px; padding-left:10px; border-left:1px dashed #00ff66; }
    .comment { margin:6px 0; font-size:13px; }

    textarea {
      width:100%; background:#000; color:#00ff66; border:1px solid #00ff66; border-radius:6px; padding:8px; resize:vertical;
      font-family:"Courier New", monospace;
    }

    body::after {
      content:""; position:fixed; inset:0; pointer-events:none;
      background: repeating-linear-gradient(to bottom, rgba(0,255,102,.08) 0px, rgba(0,255,102,.05) 2px, transparent 4px);
      animation: flicker 1.5s infinite;
    }
    @keyframes flicker { 0%{opacity:.9} 50%{opacity:.7} 100%{opacity:.9} }
  </style>
</head>
<body>
  <div class="top">
    <a class="link" href="/index.html">üéÆ Back to Game</a>
    <h1>üìñ Storyboard</h1>
    <div class="nick">
      <label for="handle">Nickname:</label>
      <input id="handle" placeholder="Anon">
    </div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <div class="row">
      <label for="fTitle">Story name</label>
      <input id="fTitle" placeholder="e.g., lake, night...">
    </div>
    <div class="row">
      <label for="fAuthor">Author</label>
      <input id="fAuthor" placeholder="nickname">
    </div>
    <div class="row">
      <label for="fMood">Mood</label>
      <select id="fMood">
        <option value="any">Any</option>
        <option value="horror">Horror</option>
        <option value="romance">Romance</option>
        <option value="sci-fi">Sci-Fi</option>
        <option value="fantasy">Fantasy</option>
        <option value="mystery">Mystery</option>
        <option value="comedy">Comedy</option>
        <option value="noir">Detective Noir</option>
      </select>
    </div>
    <div class="row">
      <label for="fDrama">Drama</label>
      <select id="fDrama">
        <option value="any">Any</option>
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      </select>
    </div>
    <div class="row">
      <label>Sort</label>
      <div>Most recent</div>
      <!-- (Server already sorts by created_at desc) -->
    </div>
    <div class="row">
      <label>&nbsp;</label>
      <div class="actions">
        <button id="apply">Apply</button>
        <button id="clear">Clear</button>
      </div>
    </div>
  </div>

  <div class="status" id="status">Loading‚Ä¶</div>

  <div id="stories"></div>

  <script>
    const storiesEl = document.getElementById('stories');
    const statusEl  = document.getElementById('status');
    const handleEl  = document.getElementById('handle');

    const fTitle  = document.getElementById('fTitle');
    const fAuthor = document.getElementById('fAuthor');
    const fMood   = document.getElementById('fMood');
    const fDrama  = document.getElementById('fDrama');
    const btnApply = document.getElementById('apply');
    const btnClear = document.getElementById('clear');

    // Nickname same as game
    handleEl.value = localStorage.getItem('story_handle') || '';
    handleEl.onchange = () => localStorage.setItem('story_handle', handleEl.value.trim());

    // Anonymous client_id (same as game)
    let clientId = localStorage.getItem('client_id');
    if (!clientId) {
      clientId = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(36).slice(2));
      localStorage.setItem('client_id', clientId);
    }

    function escapeHtml(str) {
      return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }
    function setStatus(msg) { statusEl.textContent = msg; }

    function buildQuery() {
      const p = new URLSearchParams();
      if (fTitle.value.trim())  p.set('title',  fTitle.value.trim());
      if (fAuthor.value.trim()) p.set('author', fAuthor.value.trim());
      if (fMood.value !== 'any')   p.set('mood',  fMood.value);
      if (fDrama.value !== 'any')  p.set('drama', fDrama.value);
      p.set('limit', '50');
      return '/api/storyboard/list?' + p.toString();
    }

    async function loadStories() {
      try {
        setStatus('Loading stories‚Ä¶');
        const r = await fetch(buildQuery(), { cache: 'no-store' });
        const j = await r.json();
        if (!r.ok) throw new Error(j.error || ('HTTP ' + r.status));
        const list = Array.isArray(j.stories) ? j.stories : [];
        renderStories(list);
        setStatus(list.length ? 'Loaded.' : 'No stories found. Try different filters.');
      } catch (e) {
        console.error('List error:', e);
        setStatus('Error: ' + e.message);
        storiesEl.innerHTML = '';
      }
    }

    function renderStories(list) {
      if (!list.length) { storiesEl.innerHTML = '<div>No stories match.</div>'; return; }
      storiesEl.innerHTML = '';
      list.forEach(s => {
        const div = document.createElement('div');
        div.className = 'story';
        const preview = (s.content || '').slice(0, 1200);
        div.innerHTML = `
          <div class="title">${escapeHtml(s.title || '(Untitled)')}</div>
          <div class="meta">
            By ${escapeHtml(s.author || 'Anon')}
            ¬∑ Mood: ${escapeHtml(s.mood || '‚Äî')}
            ¬∑ Drama: ${s.drama ?? '‚Äî'}
            ¬∑ ${s.created_at ? new Date(s.created_at).toLocaleString() : ''}
          </div>
          <div class="content">${escapeHtml(preview)}${(s.content && s.content.length > 1200) ? '‚Ä¶' : ''}</div>
          <div class="actions">
            <span id="counts-${s.id}">üëç ${s.likes || 0}</span>
            <button data-like="${s.id}">Like</button>
            <button data-toggle-comments="${s.id}">Comments</button>
          </div>
          <div id="comments-${s.id}" class="comments" style="display:none;"></div>
        `;
        storiesEl.appendChild(div);
      });
      wireButtons();
    }

    function wireButtons() {
      storiesEl.querySelectorAll('button[data-like]').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.getAttribute('data-like');
          const counter = document.getElementById('counts-' + id);
          const m = counter.textContent.match(/üëç\s*(\d+)/);
          if (m) counter.textContent = `üëç ${parseInt(m[1],10)+1}`;
          btn.disabled = true;
          try {
            await fetch('/api/storyboard/react', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ story_id: id, client_id: clientId })
            }).then(r => r.json().catch(()=>({})));
            setTimeout(loadStories, 600);
          } catch (e) {
            if (m) counter.textContent = `üëç ${parseInt(m[1],10)}`;
            btn.disabled = false;
            alert('Like failed: ' + e.message);
          }
        };
      });
      storiesEl.querySelectorAll('button[data-toggle-comments]').forEach(btn => {
        btn.onclick = () => toggleComments(btn.getAttribute('data-toggle-comments'));
      });
    }

    async function toggleComments(storyId) {
      const box = document.getElementById('comments-' + storyId);
      if (box.style.display === 'none') { await loadComments(storyId); box.style.display = 'block'; }
      else { box.style.display = 'none'; }
    }

    async function loadComments(storyId) {
      const box = document.getElementById('comments-' + storyId);
      box.innerHTML = 'Loading comments‚Ä¶';
      try {
        const r = await fetch('/api/storyboard/comments?story_id=' + encodeURIComponent(storyId), { cache: 'no-store' });
        const j = await r.json();
        if (!r.ok) throw new Error(j.error || ('HTTP ' + r.status));
        const items = (j.comments || []).map(c =>
          `<div class="comment"><b>${escapeHtml(c.handle || 'Anon')}:</b> ${escapeHtml(c.body || '')}</div>`
        ).join('');
        box.innerHTML = `
          ${items || '<div class="comment">No comments yet.</div>'}
          <div style="margin-top:8px;">
            <textarea id="comment-input-${storyId}" rows="3" placeholder="Write a comment‚Ä¶"></textarea>
            <div style="margin-top:6px;">
              <button id="post-${storyId}">Post Comment</button>
            </div>
          </div>
        `;
        document.getElementById('post-' + storyId).onclick = async () => {
          const txt = document.getElementById('comment-input-' + storyId).value.trim();
          if (!txt) return;
          const handle = (handleEl.value || localStorage.getItem('story_handle') || 'Anon').trim() || 'Anon';
          try {
            await fetch('/api/storyboard/comment', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ story_id: storyId, body: txt, handle })
            });
            await loadComments(storyId);
          } catch (e) { alert('Comment failed: ' + e.message); }
        };
      } catch (e) {
        console.error('Comments error:', e);
        box.innerHTML = `<div class="comment">[Error: ${escapeHtml(e.message)}]</div>`;
      }
    }

    // Filter actions
    btnApply.onclick = loadStories;
    btnClear.onclick = () => {
      fTitle.value = '';
      fAuthor.value = '';
      fMood.value = 'any';
      fDrama.value = 'any';
      loadStories();
    };
    // Enter key triggers apply in text inputs
    [fTitle, fAuthor].forEach(inp => inp.addEventListener('keydown', e => { if (e.key === 'Enter') btnApply.click(); }));

    // Initial load
    loadStories();
  </script>
</body>
</html>
