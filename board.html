<a href="/index.html" style="color:#00ff66; text-decoration:none; border:1px solid #00ff66; padding:6px 10px; border-radius:6px;">
  üéÆ Back to Game
</a>

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Storyboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: "Courier New", monospace; background: #000; color: #00ff66; margin: 20px; }
    h1 { text-align: center; text-shadow: 0 0 10px #00ff66; margin-bottom: 14px; }
    .bar { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
    a { color:#00ff66; text-decoration:none; border-bottom:1px dashed #00ff66; }
    a:hover { color:#000; background:#00ff66; }
    #stories { margin-top: 10px; }

    .story { border:1px solid #00ff66; border-radius:8px; background:#0a0a0a; padding:12px; margin:12px 0; }
    .title { font-weight:bold; margin-bottom:6px; }
    .meta { font-size:12px; opacity:.8; margin-bottom:8px; }
    .content { white-space:pre-wrap; margin-bottom:8px; }
    .actions { display:flex; gap:8px; align-items:center; margin-top:6px; }
    .actions button {
      background:#000; color:#00ff66; border:1px solid #00ff66; padding:6px 10px; border-radius:6px; cursor:pointer;
    }
    .actions button:hover { background:#00ff66; color:#000; }

    .comments { margin-top:10px; padding-left:10px; border-left:1px dashed #00ff66; }
    .comment { margin:6px 0; font-size:13px; }
    textarea {
      width:100%; background:#000; color:#00ff66; border:1px solid #00ff66; border-radius:6px; padding:8px; resize:vertical;
      font-family:"Courier New", monospace;
    }

    /* Scanline vibe */
    body::after {
      content:""; position:fixed; inset:0; pointer-events:none;
      background: repeating-linear-gradient(to bottom, rgba(0,255,102,.08) 0px, rgba(0,255,102,.05) 2px, transparent 4px);
      animation: flicker 1.5s infinite;
    }
    @keyframes flicker { 0%{opacity:.9} 50%{opacity:.7} 100%{opacity:.9} }
  </style>
</head>
<body>
  <div class="bar">
    <h1>üìñ Storyboard</h1>
    <a href="/index.html">‚Üê Back to Game</a>
  </div>

  <div id="stories">Loading‚Ä¶</div>

  <script>
    const storiesEl = document.getElementById('stories');

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    async function loadStories() {
      try {
        const r = await fetch('/api/storyboard/list');
        const j = await r.json();
        if (!r.ok) throw new Error(j.error || 'Failed to load');

        if (!j.stories || j.stories.length === 0) {
          storiesEl.innerHTML = '<div>No stories yet. Be the first to share from the game screen!</div>';
          return;
        }

        storiesEl.innerHTML = '';
        j.stories.forEach(s => {
          const div = document.createElement('div');
          div.className = 'story';
          const preview = (s.content || '').slice(0, 400);
          div.innerHTML = `
            <div class="title">${escapeHtml(s.title || '(Untitled)')}</div>
            <div class="meta">Mood: ${escapeHtml(s.mood || '‚Äî')} ¬∑ Drama: ${s.drama ?? '‚Äî'} ¬∑ ${new Date(s.created_at).toLocaleString()}</div>
            <div class="content">${escapeHtml(preview)}${s.content.length > 400 ? '‚Ä¶' : ''}</div>
            <div class="actions">
              <span>üëç ${s.likes || 0} ¬∑ üëé ${s.dislikes || 0}</span>
              <button data-like="${s.id}">Like</button>
              <button data-dislike="${s.id}">Dislike</button>
              <button data-toggle-comments="${s.id}">Comments</button>
            </div>
            <div id="comments-${s.id}" class="comments" style="display:none;"></div>
          `;
          storiesEl.appendChild(div);
        });

        // wire buttons
        storiesEl.querySelectorAll('button[data-like]').forEach(btn => {
          btn.onclick = () => react(btn.getAttribute('data-like'), 1);
        });
        storiesEl.querySelectorAll('button[data-dislike]').forEach(btn => {
          btn.onclick = () => react(btn.getAttribute('data-dislike'), -1);
        });
        storiesEl.querySelectorAll('button[data-toggle-comments]').forEach(btn => {
          btn.onclick = () => toggleComments(btn.getAttribute('data-toggle-comments'));
        });
      } catch (e) {
        storiesEl.innerHTML = `<div>[Error: ${escapeHtml(e.message)}]</div>`;
      }
    }

    async function react(id, value) {
      try {
        await fetch('/api/storyboard/react', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ story_id: id, value })
        });
        loadStories();
      } catch {}
    }

    async function toggleComments(storyId) {
      const box = document.getElementById('comments-' + storyId);
      if (box.style.display === 'none') {
        await loadComments(storyId);
        box.style.display = 'block';
      } else {
        box.style.display = 'none';
      }
    }

    async function loadComments(storyId) {
      const box = document.getElementById('comments-' + storyId);
      box.innerHTML = 'Loading comments‚Ä¶';
      try {
        const r = await fetch('/api/storyboard/comments?story_id=' + storyId);
        const j = await r.json();
        if (!r.ok) throw new Error(j.error || 'Failed to load comments');

        const items = (j.comments || []).map(c =>
          `<div class="comment"><b>${escapeHtml(c.handle || 'Anon')}:</b> ${escapeHtml(c.body)}</div>`
        ).join('');

        box.innerHTML = `
          ${items || '<div class="comment">No comments yet.</div>'}
          <div style="margin-top:8px;">
            <textarea id="comment-input-${storyId}" rows="3" placeholder="Write a comment‚Ä¶"></textarea>
            <div style="margin-top:6px;">
              <button id="post-${storyId}">Post Comment</button>
            </div>
          </div>
        `;

        document.getElementById('post-' + storyId).onclick = async () => {
          const txt = document.getElementById('comment-input-' + storyId).value.trim();
          if (!txt) return;
          await fetch('/api/storyboard/comment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ story_id: storyId, body: txt, handle: 'Anon' })
          });
          loadComments(storyId);
        };
      } catch (e) {
        box.innerHTML = `<div class="comment">[Error: ${escapeHtml(e.message)}]</div>`;
      }
    }

    loadStories();
  </script>
</body>
</html>
